More function and more nested loop
